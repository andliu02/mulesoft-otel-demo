# EDOT Java Agent Setup for MuleSoft Community Runtime

## What EDOT gives you on MuleSoft

- **Traces** — Mule flow spans + outbound HTTP spans + inferred spans (fills gaps between flows)
- **Metrics** — JVM heap, GC pauses, thread pools, HTTP client/server duration
- **Logs** — Mule runtime logs correlated to traces by `trace.id`
- **Central Configuration** — adjust sampling/verbosity from Elastic UI without restarting Mule

## Download EDOT Java Agent

```bash
# Download latest EDOT Java agent
curl -L -o /opt/edot/elastic-otel-javaagent.jar \
  https://github.com/elastic/elastic-otel-java/releases/latest/download/elastic-otel-javaagent.jar
```

## Attach to Mule Community Runtime

The cleanest way is via `JAVA_TOOL_OPTIONS` — Mule picks it up automatically on start:

```bash
export JAVA_TOOL_OPTIONS="-javaagent:/opt/edot/elastic-otel-javaagent.jar"

export OTEL_SERVICE_NAME="mulesoft-anypoint-runtime"
export OTEL_RESOURCE_ATTRIBUTES="service.version=4.6.1,deployment.environment=production,mule.app.name=fnb-integration,mule.runtime.version=4.6.1"

# Send to local OTel Collector (which routes to Elastic Cloud)
export OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:4317"

# OR send directly to Elastic Cloud APM (skip collector)
# export OTEL_EXPORTER_OTLP_ENDPOINT="https://YOUR_APM_URL"
# export OTEL_EXPORTER_OTLP_HEADERS="Authorization=Bearer YOUR_SECRET_TOKEN"

# Enable inferred spans (fills latency gaps inside flows)
export ELASTIC_OTEL_INFERRED_SPANS_ENABLED="true"
export ELASTIC_OTEL_INFERRED_SPANS_SAMPLING_INTERVAL="5ms"

# Capture HTTP headers in spans (useful for correlation ID visibility)
export OTEL_INSTRUMENTATION_HTTP_SERVER_CAPTURE_REQUEST_HEADERS="X-Correlation-ID,X-Teller-ID,X-Branch-Code"
export OTEL_INSTRUMENTATION_HTTP_CLIENT_CAPTURE_REQUEST_HEADERS="X-Correlation-ID,X-Source-System"

# Start Mule
/opt/mule/bin/mule start
```

## What you'll see in Elastic

### Service Map
```
fnb-portal → mulesoft-anypoint-runtime → core-banking-svc
                                        → fraud-detection-svc
                                        → aml-screening-svc
                                        → customer-profile-svc
                                        → notification-svc
```

### Trace Waterfall (payment-processing-wire-flow)
```
fnb-portal: portal.initiateWireTransfer
  └── HTTP POST mulesoft:8081/api/payments/wire        ← portal span
        └── mule:payment-processing-wire-flow           ← EDOT span
              ├── [inferred] DataWeave:transform         ← EDOT inferred span
              ├── HTTP POST fraud-detection-svc:9002     ← EDOT auto-instrumented
              │     └── fraud.scoreTransaction           ← fraud service span
              │           ├── fraud.rule.velocity_check
              │           └── fraud.rule.behavioral_model
              ├── HTTP POST aml-screening-svc:9003       ← EDOT auto-instrumented
              │     └── aml.screenTransaction
              ├── HTTP GET  core-banking-svc:9001        ← SLOW QUERY HERE
              │     └── core-banking.getBalance
              │           └── db.SELECT accounts_ledger  ← 4,500ms slow query
              ├── HTTP POST core-banking-svc:9001
              │     └── core-banking.debitAccount
              └── HTTP POST notification-svc:9005
                    └── notification.send
```

### Key Span Attributes (visible in Elastic trace detail)
```
mule.flow.name: payment-processing-wire-flow
mule.correlation.id: <uuid>
http.request.header.x-correlation-id: <uuid>
http.request.header.x-teller-id: TLR042
fraud.score: 0.23
fraud.decision: ALLOW
aml.result: CLEARED
db.slow_query: true                    ← THE DEMO MOMENT
db.sql.table: accounts_ledger
db.slow_query.reason: table_lock_contention
db.slow_query.actual_ms: 4523
```

## Mule Community Runtime Install

```bash
# Download Mule 4.6 Community Edition
curl -L -o /tmp/mule-community-4.6.tar.gz \
  https://repository.mulesoft.org/nexus/content/repositories/releases/org/mule/distributions/mule-standalone/4.6.1/mule-standalone-4.6.1.tar.gz

tar -xzf /tmp/mule-community-4.6.tar.gz -C /opt/
ln -s /opt/mule-standalone-4.6.1 /opt/mule

# Create EDOT directory
mkdir -p /opt/edot
```

## Deploy Mule Apps (Flow XMLs)

Copy the flow XMLs from this repo into the Mule apps directory:

```bash
mkdir -p /opt/mule/apps/fnb-integration
cp mulesoft/flows/*.xml /opt/mule/apps/fnb-integration/
cp mulesoft/mule-app.properties /opt/mule/apps/fnb-integration/
```

## Properties File

`mule-app.properties` (generated by Terraform startup script):

```properties
backend.corebanking.host=<APP_VM_INTERNAL_IP>
backend.corebanking.port=9001
backend.fraud.host=<APP_VM_INTERNAL_IP>
backend.fraud.port=9002
backend.aml.host=<APP_VM_INTERNAL_IP>
backend.aml.port=9003
backend.crm.host=<APP_VM_INTERNAL_IP>
backend.crm.port=9004
backend.notification.host=<APP_VM_INTERNAL_IP>
backend.notification.port=9005
```

These are injected by Terraform using the app-vm's internal GCP IP.

## Verify EDOT is Working

```bash
# Check Mule started with agent
ps aux | grep mule | grep javaagent

# Tail Mule logs — look for OpenTelemetry initialisation
tail -f /opt/mule/logs/mule.log | grep -i "opentelemetry\|elastic-otel"

# Hit a flow and check Elastic APM within 30 seconds
curl -X POST http://localhost:8081/api/payments/wire \
  -H "Content-Type: application/json" \
  -H "X-Correlation-ID: test-$(date +%s)" \
  -d '{"sourceAccount":"ACC00000001","destinationAccount":"EXT12345678","amount":5000,"currency":"USD","paymentType":"WIRE","destinationCountry":"US","purpose":"TEST"}'
```
